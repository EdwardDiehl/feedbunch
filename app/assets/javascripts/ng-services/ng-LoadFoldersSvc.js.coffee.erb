########################################################
# AngularJS service to load feeds
########################################################

angular.module('feedbunch').service 'loadFoldersSvc',
['$rootScope', '$http', 'findSvc', 'cleanupSvc', 'timerFlagSvc',
($rootScope, $http, findSvc, cleanupSvc, timerFlagSvc)->

  #--------------------------------------------
  # PRIVATE FUNCTION: Load folders.
  #--------------------------------------------
  load_folders = ->
    $http.get("/api/folders.json")
    .success (data)->

      # Remove folders no longer existing in the server
      if $rootScope.folders? && $rootScope.folders?.length > 0
        for folder in $rootScope.folders
          existing_folder = findSvc.find_folder folder.id, data
          if !existing_folder?
            cleanupSvc.remove_folder folder.id

      # Add new folders
      if data? && data.length? > 0
        for folder in data
          add_folder folder

      $rootScope.folders_loaded = true
    .error (data, status)->
      $rootScope.folders_loaded = true
      timerFlagSvc.start 'error_loading_folders' if status!=0

  #---------------------------------------------
  # PRIVATE FUNCTION: Push a folder in the folders array if it isn't already present there.
  #
  # If the folders array has not been created in the root scope, create it.
  #
  # If the folder is already in the folders array, it is ignored
  #---------------------------------------------
  add_folder = (folder)->
    if !$rootScope.folders || $rootScope.folders?.length == 0
      $rootScope.folders = [folder]
    else
      old_folder = findSvc.find_folder folder.id
      $rootScope.folders.push folder if !old_folder?

  service =

    #--------------------------------------------
    # Load folders via AJAX into the root scope.
    #--------------------------------------------
    load_folders: load_folders

    #---------------------------------------------
    # Push a folder in the folders array.
    #---------------------------------------------
    add_folder: add_folder

  return service
]